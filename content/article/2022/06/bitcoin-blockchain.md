---
title: Bitcoin, Blockchain
date: '2022-06-21'
categories: 
    - bitcoin
---

# 中本聪的愿望
> “传统货币最根本的问题在于信任。中央银行必须让人信任它不会让货币贬值，但历史上这种可信度从来都不存在。银行必须让人信任它能管理好钱财，并让这些财富以电子货币形式流通，但银行却用货币来制造信贷泡沫，使得私人财富缩水。”

1933年4月5日，为了使政府能够再印制更多现金注入市场，罗斯福总统签署了6102号行政命令，要求美国公民以每金衡盎司20.67美元的价格上交黄金，否则可处以10,000美元的罚款，甚至还可判处入狱服刑5至10年，同时也禁止黄金出口海外，以确保美国拥有的黄金不会外流。
{{< figure src="https://s2.loli.net/2022/06/21/jV6NfbAmLZOs2RB.png" title="Executive Order 6102">}}

罗斯福没收充公美国人的黄金，并以美元交换，然后让美元贬值了40%，强制推高黄金价，目的是让美国的债务贬值，从而对抗大萧条，造成的后果是美国人的财富被洗劫了40%。

1974 年，福特总统签署了 Public Law 93-373 即“黄金合法化法案”，1975年美国人可以再一次合法拥有黄金。
{{< figure src="https://s2.loli.net/2022/06/21/on7U1KjtDR8kgxc.png" title="Satoshi Nakamoto's Profile">}}

P2PFoundation 是中本聪发布比特币白皮书的网站，在这注册必须提供出生日期，中本聪填写的是1975年4月5日。

# 电子支付的问题
互联网上的贸易，几乎都需要借助金融机构作为可资信赖的第三方来处理电子支付信息。是这类系统仍然内生性地受制于“基于信用的模式”的弱点：
- 无法实现完全不可逆的交易，因为金融机构总是不可避免地会出面协调争端。
- 金融中介的存在增加交易的成本，并且限制了实际可行的最小交易规模，也限制了日常的小额支付交易。

**这些问题在物理现金交易中是不存在的。**

所以需要这样一种电子支付系统，它基于密码学原理而不基于信用，使得任何达成一致的双方，能够直接进行支付，从而不需要第三方中介的参与。

## 雅浦岛的故事
雅浦岛是一个金属资源比较匮乏的岛，就算是石灰岩也要去400英里以外的帕劳岛开采。雅浦岛部落里的探险家们开采这些石灰岩，打制成内部中空呈环形的石轮，然后用木筏运回雅浦岛作为货币使用。这些石轮小的直径30多厘米，大的直径有3米多。为了便于运输，有时会往中间插一根粗壮的木柱。开采难度越高，越漂亮，越大的石币价值越高。
{{< figure src="https://s2.loli.net/2022/06/21/zFaCbefmlY1Hod9.png" title="雅浦岛的石币">}}

雅浦石币有个很有趣的特点。交易双方在决定了使用多大的石币付费后，如果那个石头太大了，不方便运输，那么卖家只要在买家的石头上做个标记就可以了，这样就付费了。那个标记就说明这个石头已经属于卖家了，而石头仍然躺在买家屋里。
{{< figure src="https://s2.loli.net/2022/06/21/KuiDO8UY426qXyH.png" title="雅浦岛的石币">}}

岛上有一户首富，但没有人见过他家里的石币。他们家拥有的财产是一个巨大的石币，大小只有上上辈人才知道，因为这个石币一直沉睡在海底。这户人家的祖辈和其他人外出开采石灰岩并制成石币，在用木筏拉回家的归途中遭遇了强烈的暴风雨，为了逃命，探险队只好砍掉拉筏的绳子，于是那块巨大的石币沉入了大海。回村后探险队的成员都替他作证，虽然已掉落大海，但大伙都见证了这块石头的去处，所以不会影响它的价值，它的主人仍然可以用它去买东西，就跟把石币运回家存放起来的效果一样。

## 比特币和石币
如果雅浦岛首富想要私下使用这笔巨款，比如偷偷跟自己的情人说：我那块大石头送给你了。这次交易是无效的，因为交易没有广播，并没有其他岛民在旁边作证。但如果首富临死前，当着全岛人民的面说，这块大石头就作为遗产给我的大儿子了。那么这笔交易就是有效的，因为其他岛民都做了见证，并集体更新了头脑里的“账簿”。

假如雅浦岛上的交易越来越多，大家根本记不住这么多交易，所以打算使用比特币：
> 石币：大家都知道这个石币的所有人是村民1，那么他可以将其转账给村民2  
> 比特币：大家都知道这个比特币的所有人是村民1，那么他可以将其转账给村民2

在传统的交易中，采取的是**账户/余额模型**。比如银行账户、微信账户，都是基于账户/余额模型。
**账户内的余额是作为一个整体存在的。**

而比特币采用的是 **UTXO (Unspent Transaction Output) 模型**
{{< figure src="https://s2.loli.net/2022/06/21/qAb2Dczn8wNpI1f.png" title="BTC Transaction">}}

在比特币中，一笔交易的每一条输入和输出实际上都是 UTXO，输入 UTXO 就是以前交易剩下的， 更准确的说是以前交易的输出 UTXO。除了 coinbase 交易（挖矿奖励）没有输入 UTXO 之外，其它交易都有输入和输出，都可以为多个。在比特币中没有余额概念，只有分散到区块链里的 UTXO。

### 谁拥有 UTXO
在雅浦岛上，村民之间可以确定这个石币的所有者是谁。而比特币转账实际上是从一个地址被移动到另一个地址，当村民1想花费0.15个比特币时，如何证明自己拥有这个 UTXO，并且其他人无法假冒村民1来花费这个 UTXO 呢？

比特币的交易创建的输出其实并非一个简单的公钥地址，而是一个脚本。每一个比特币节点会通过同时执行这解锁和锁定脚本（**不是当前的锁定脚本，是指上一个交易的锁定脚本**）来验证一笔交易，脚本组合结果为真，则为有效交易。
{{< figure src="https://s2.loli.net/2022/06/21/6crY1BlWwi4zD7q.png" title="BTC 交易脚本">}}

这个脚本表达的意思是：谁的签名能匹配这个输出地址，钱就支付给谁。

所有人都可以验证村民1创建的这个新交易是否有效。如果有效，该交易就会被矿工打包进新的区块，从而成为区块链上不可更改的一部分。
> **什么是数字签名**
>
> A 给 B 发送消息前，先对消息生成摘要 (digest)，然后 A 使用私钥对摘要进行加密得到签名 (signature)。之后 A 将签名和消息一同发送给 B
>
> B 在得到消息后，可以使用公钥将签名解密得到 digest, 然后再与消息生成的 digest 进行对比，如果两个 digest 相同则说明消息没有被篡改。

**由于签名只能由私钥生成，所以谁拥有了私钥谁就拥有了这个 UTXO。**

以 [Pizza Transaction](https://www.blockchain.com/btc/tx/cca7507897abc89628f450e8b1e0c6fca4ec3f7b34cccf55f3f531c659ff4d79) 为例，提供的唯一一个 scriptSig 为
`30450221009908144ca6539e09512b9295c8a27050d478fbb96f8addbc3d075544dc41328702201aa528be2b907d316d2da068dd9eb1e23243d97e444d59290d2fddf25269ee0e01
042e930f39ba62c6534ee98ed20ca98959d34aa9e057cda01cfd422c6bab3667b76426529382c23f42b9b08d7832d4fee1d6b437a8526e59667ce9c4e9dcebcabb`

其中 `3045...ee0e` 是签名，`042e...abb` 是公钥。  
为了验证该交易是否有效，需要验证上一笔交易 [`a1075db5...d48d`](https://www.blockchain.com/btc/tx/a1075db55d416d3ca199f55b6084e2115b9345e16c5cf302fc80e9d5fbf5d48d) 的输出
`1976a91446af3fb481837fadbb421727f9959c2d32a3682988ac`  
翻译后的比特币指令如下：  
`OP_DUP OP_HASH160 46af3fb4...6829 OP_EQUALVERIFY OP_CHECKSIG`

现在，有了签名，公钥和脚本就可以运行这个脚本来验证交易是否有效。
{{< figure src="https://s2.loli.net/2022/06/21/Uu4Rt37cxoqswJY.png" title="解锁脚本">}}

首先要准备一个空栈，然后把签名和公钥入栈，然后执行 OP_DUP，这条指令把栈顶的元素复制一份，所以结果变成：

||
|---|
|pubkey: 042e930f...cabb|
|pubkey: 042e930f...cabb|
|sig: 30450221...ee0e01|

然后可以执行TxOut的脚本：  
`OP_DUP OP_HASH160 46af3fb4...6829 OP_EQUALVERIFY OP_CHECKSIG`
{{< figure src="https://s2.loli.net/2022/06/21/vO3WDwFIkgA1LmY.png" title="验签">}}

执行 OP_HASH160，它对栈顶元素计算 SHA256/RipeMD160，实际上是计算公钥 Hash。再把数据入栈后运行结果变成：

||
|---|
|*data: 46af3fb4...6829*|
|*hash: 46af3fb4...6829*|
|pubkey: 042e930f...cabb|
|sig: 30450221...ee0e01|

最后，执行指令 OP_CHECKSIG 验证签名是否有效。

### 记账与挖矿
> 石币：两个人要交易时，把全村人都叫过来作见证，大家记在脑子里，或者记载自己的小本本上。  
> 比特币：两个人要交易时，向网络中所有节点广播。网络中各节点达成共识。

在比特币网络中，负责记账的节点被称为“矿工节点”。在用户发起交易时会向网络中广播交易，每个节点将收到的交易信息纳入一个区块中，并尝试在自己的区块中找到一个具有足够难度的工作量证明。当一个节点找到了一个工作量证明，它就向全网进行广播。
{{< figure src="https://s2.loli.net/2022/06/21/YG7vSlnBzV1bZjL.png" title="两个矿工节点各自挖到了一个区块">}}

当且仅当包含在该区块中的所有交易都是有效的且之前未存在过的，其他节点才认同该区块的有效性；其他节点表示他们接受该区块，在跟随该区块的末尾制造新的区块以延长该链条。矿工们在挖矿过程中会得到两种类型的奖励：创建新区块的新币奖励，以及区块中所含交易的交易费。

#### 双重支付
数字签名只能证明钱是本人转出的；哈希链只能保证篡改了账本的前一页、后一页就无效了。如果从账本上，把含有这笔转出交易的一页（以及后面的几页）撕掉，然后重新写一页，把原来那笔钱转给另一个地址，这就是**双重支付（双花）**。想要“**中心化**”地实现“我转了钱，钱就不在我手里了”，就得需要一个共识算法来保障。比特币作为一个实质上的分布式数据库，各节点达成一致需要共识算法来协商。而 Paxos、Raft 等 Leader-Follower 模式的算法不符合去中心化的要求。比特币使用 **PoW (Proof-of-Work)** 在网络中达成共识。
{{< figure src="https://s2.loli.net/2022/06/21/hXYEiLsxTMNl9D2.png" title="两个矿工节点各自挖到了一个区块">}}

#### [HashCash](http://www.hashcash.org/papers/hashcash.pdf)
在垃圾邮件和 DDoS 中，攻击方几乎是没有代价的。垃圾邮件软件可以批量、高并发的发送邮件给目标地址； DDoS 可以利用海量的肉鸡对目标主机进行网络请求从而使目标主机限于瘫痪。

Hashcash 解决这些问题的手段是让攻击方付出一些计算资源的“代价”。首先，目标方会按照既定规则给出一道数学题，这道数学题的结果不可复用（每次请求需要重新计算）。为了得出结果，需要一些 CPU 的计算资源，然后把计算结果附在请求上提交给目标方，目标方可以非常轻易的验证结果是否正确。这道数学题的难度可以定义。

#### Bitcoin 中的 PoW
比特币 PoW 的过程，就是将不同的 nonce 值作为输入，尝试进行 SHA256 哈希运算，找出满足给定数量前导0的哈希值的过程。要求的前导0的个数越多，代表难度越大。
{{< figure src="https://s2.loli.net/2022/06/21/rOVRPAfyjG5EqW1.png" title="区块的数据结构">}}

比特币节点求解工作量证明问题的步骤归纳如下:
1. 生成铸币交易，并与其他所有准备打包进区块的交易组成区块，通过 Merkle 树算法生成 Merkle 根哈希；
2. 把 Merkle 根哈希及其他相关字段组装成区块头，将区块头的80字节数据作为工作量证明的输入；
3. 不停地变更区块头中的随机数 nonce，并对每次变更后的区块头做双重 SHA256 运算，将结果值与当前网络的目标难度做比对，如果满足难度条件，则解题成功，工作量证明完成。该矿工获得记账权，生成新区块并广播到全网。