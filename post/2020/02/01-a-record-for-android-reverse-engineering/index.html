<!doctype html><html lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>0xab.de</title><link rel=stylesheet href=/css/style.css><link rel=stylesheet href=/css/fonts.css><link rel=stylesheet href=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/github.min.css><script src=//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script>hljs.initHighlightingOnLoad();</script></head><body><nav><ul class=header><li><a href=/post/>Post</a></li><li><a href=/translation/>Translation</a></li><li><a href=/weekly/>Weekly</a></li><li><a href=/categories/>Categories</a></li><li><a href=/tags/>Tags</a></li><li><a href=/feed.xml>Subscribe</a></li></ul><hr></nav></body></html><a class=article__tag href=https://0xab.de/categories/security-related>security related</a><br><br><center><span class=title>A record for android reverse engineering
<span class=link></span></span></center><span class=date>Feb 01, 2020</span>
<span class=dot></span><span class=link><a href=/post/2020/02/01-a-record-for-android-reverse-engineering/>https://0xab.de/post/2020/02/01-a-record-for-android-reverse-engineering/</a></span><br></span><hr></div><main><h2 id=起因>起因</h2><p>凌晨在 QQ 空间看到一个同校同学发布了一款 App，正在邀请别人参加内测。正巧最近我也在帮朋友写一个小应用，便下载来研究一下。应用的主题很常见，主打校内论坛、交友功能，大概猜到是怎么回事，还是先抓包看看吧。</p><h2 id=抓包>抓包</h2><p>Charles 这个工具就不用说了，基本抓过包的朋友都用过。不过想要抓手机应用，前提要求手机和电脑在一个局域网络中。设置代理和安装证书这两个步骤很容易找到教程，这里不再赘述。需要注意的是 Android 7 以后按谷歌要求需要额外修改 APP 的网络安全性配置，我这里参考这篇文章<sup class=footnote-ref id=fnref:https-mp-weixin><a href=#fn:https-mp-weixin>1</a></sup>得以解决。</p><p>抓到包之后看了一眼 Request 和 Response 格式，看上去不太规范。而且虽然加入了 token，但是很多接口没有鉴权，拿到接口直接请求就能修改所有用户的资料。由于是内测，我将开发者的昵称修改以提示其漏洞，同时也在内测群里反馈了，截止目前接口还没有修改。除此之外，修改密码等接口中的密码竟然是明文传输的，这让我不能不担心是否在数据库中也是明文存储密码？于是诞生了 hack 进数据库的想法。</p><h2 id=调研>调研</h2><p>在处理数据库相关问题之前，先判断出其应用的技术栈。后端是拿 php 写的，而据我所知 php 框架经常爆出漏洞，在此基础之上发现是 thinkphp v5.0.24，而此版本已将漏洞修复了。此外又发现服务器上安装了宝塔面板，开发者开启了安全登录入口，默认的后台地址被修改了，这条路径也只能放弃了。</p><h2 id=撞库>撞库</h2><p>我之前没有接触过安全方面的技术，但是最简单的撞库的思想还是有的。在网上找了一些密码字典，一共包括5000多个常用的密码，用 hydra<sup class=footnote-ref id=fnref:https-github-com><a href=#fn:https-github-com>2</a></sup> 暴力撞库，但是失败了。</p><h2 id=sql-注入>SQL 注入</h2><p>撞库失败后联想到 SQL 注入的方式，找到了 sqlmap<sup class=footnote-ref id=fnref:https-sqlmap-org><a href=#fn:https-sqlmap-org>3</a></sup> 这个工具。拿几个接口都测了一下，没有发现注入点这条路也只能放弃。</p><h2 id=逆向工程>逆向工程</h2><p>既然服务端没有收获，那么就尝试从客户端入手。拿来 apk 解压得到 dex 文件，果然没有加壳。用 dex2jar<sup class=footnote-ref id=fnref:https-github-com><a href=#fn:https-github-com>4</a></sup>将其转成 jar。这里遇到一个问题<sup class=footnote-ref id=fnref:https-sourceforg><a href=#fn:https-sourceforg>5</a></sup>，在 GitHub 上最新的 release(2.1 or later) 已经解决。之后用 Java Decompiler<sup class=footnote-ref id=fnref:http-java-decomp><a href=#fn:http-java-decomp>6</a></sup> 打开 jar 查看源码。仔细查找后，奇怪地发现所有包都是导入的依赖，没有域名对应的包，也没有开发者编写的代码。这明显不合理。后来想到用 adb 来找当前栈顶 Activity 的方法。</p><pre><code class=language-bash>adb shell dumpsys activity activities | sed -En -e '/Running activities/,/Run #0/p'  
</code></pre><p>结果竟然是 <code>uni.UNIC0381B1.io.dcloud.PandoraEntryActivity</code>。前面的 uni 是 apk 的签名，这在我安装时还在猜测他的具体含义。后面的 dcloud 我在抓包时候看到过，是用来统计数据的。但是用来统计数据怎么会单独开一个 Activity?</p><p>搜索一下，答案揭晓了：原来 uni-app 是 DCloud 提供的 App 跨平台开发框架&hellip;虽然我怀疑这个应用过不是用原始 Android 开发的，但是谁能想到有人拿这个东西去写 App。弄了半天，竟然被抓包时候的数据欺骗了。回到源码，既然这个应用是用这个来开发的，那么在官方文档中就能找到端倪。仔细一看，果然是用 JS 写的，将 apk 解压后源码全出来了。这时突然想起，请求都是发往服务端处理的，就算拿到了前端代码又能怎样，最多也就是找到一个 DCloud 的 key 吧。</p><h2 id=最后>最后</h2><p>折腾了一天，除了把其他用户的信息改了，最后也没能确认我的密码到底是不是明文存在数据库里的。但这这都不重要了，因为虽然用户设置了密码，但是那个应用的登录操作只能通过手机验证码来进行&hellip;</p><div class=footnotes><hr><ol><li id=fn:https-mp-weixin><a href="https://mp.weixin.qq.com/s?__biz=MzU4MjgzNzk5MA==&amp;mid=2247483695&amp;idx=1&amp;sn=020fe7fc09eec49ed84c7c111be105ce&amp;chksm=fdb372a6cac4fbb09a2152a1e71da3d18ccc68e31cad0682565d7a3af3444b05269d95ae9edc&amp;token=2000924864&amp;lang=zh_CN#rd">https://mp.weixin.qq.com/s?__biz=MzU4MjgzNzk5MA==&amp;mid=2247483695&amp;idx=1&amp;sn=020fe7fc09eec49ed84c7c111be105ce&amp;chksm=fdb372a6cac4fbb09a2152a1e71da3d18ccc68e31cad0682565d7a3af3444b05269d95ae9edc&amp;token=2000924864&amp;lang=zh_CN#rd</a> <a class=footnote-return href=#fnref:https-mp-weixin>↩</a></li><li id=fn:https-github-com><a href=https://github.com/vanhauser-thc/thc-hydra>https://github.com/vanhauser-thc/thc-hydra</a> <a class=footnote-return href=#fnref:https-github-com>↩</a></li><li id=fn:https-sqlmap-org><a href=https://sqlmap.org>https://sqlmap.org</a> <a class=footnote-return href=#fnref:https-sqlmap-org>↩</a></li><li id=fn:https-github-com><a href=https://github.com/pxb1988/dex2jar>https://github.com/pxb1988/dex2jar</a> <a class=footnote-return href=#fnref:https-github-com>↩</a></li><li id=fn:https-sourceforg><a href=https://sourceforge.net/p/dex2jar/tickets/237/>https://sourceforge.net/p/dex2jar/tickets/237/</a> <a class=footnote-return href=#fnref:https-sourceforg>↩</a></li><li id=fn:http-java-decomp><a href=http://java-decompiler.github.io/>http://java-decompiler.github.io/</a> <a class=footnote-return href=#fnref:http-java-decomp>↩</a></li></ol></div></main><div id=disqus_thread></div><script>(function(){var d=document,s=d.createElement('script');s.src='https://arjenzhou.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><footer><hr><a href=/>Home</a> <a href=https://github.com/arjenzhou>Github</a> <a href=mailto:zhouyang.zy@outlook.com>Email</a></footer></body></html>